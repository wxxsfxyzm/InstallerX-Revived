name: Manual Stable Release

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: '输入版本标签 (例如 v2.2.3)'
        required: true
      changelog:
        description: '填写更新日志 (支持 Markdown)'
        required: true
        type: string

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '25'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          # 手动发布版本无需写入构建缓存
          cache-read-only: true

      - name: Verify Keystore
        run: |
          if [ -z "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" ]; then
            echo "ERROR: SIGNING_KEY_STORE_BASE64 secret is missing"
            exit 1
          fi

      - name: Setup Signing Keys
        run: |
          mkdir -p keystore
          echo "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" | base64 --decode > keystore/carlyu.jks
          cat <<EOF > keystore.properties
          storeFile=keystore/carlyu.jks
          keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}
          keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}
          storePassword=${{ secrets.SIGNING_STORE_PASSWORD }}
          EOF

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Stable Release APKs
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew assembleOnlineStableRelease assembleOfflineStableRelease

      - name: Find and Rename Universal APKs
        id: rename_apk
        run: |
          PROJECT_NAME="InstallerX-Revived"
          VERSION_TAG="${{ inputs.version_tag }}"
          for FLAVOR in online offline; do
            APK_DIR="app/build/outputs/apk/${FLAVOR}Stable/release/"
            ORIGINAL_APK=$(find "$APK_DIR" -maxdepth 1 -type f -name "*.apk" | head -n 1)

            if [ -z "$ORIGINAL_APK" ]; then
              echo "ERROR: APK not found in $APK_DIR!"
              ls -R app/build/outputs/apk
              exit 1
            fi

            NEW_APK_NAME="${PROJECT_NAME}-${FLAVOR}-${VERSION_TAG}.apk"
            NEW_APK_PATH="${APK_DIR}${NEW_APK_NAME}"

            echo "Renaming $ORIGINAL_APK -> $NEW_APK_PATH"
            mv "$ORIGINAL_APK" "$NEW_APK_PATH"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "InstallerX Revived stable ${{ inputs.version_tag }}"
          tag_name: ${{ inputs.version_tag }}
          body: ${{ inputs.changelog }}
          prerelease: false
          files: |
            app/build/outputs/apk/onlineStable/release/InstallerX-Revived-online-${{ inputs.version_tag }}.apk
            app/build/outputs/apk/offlineStable/release/InstallerX-Revived-offline-${{ inputs.version_tag }}.apk